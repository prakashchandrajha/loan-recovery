<div class="flex h-screen bg-gray-50">
  <!-- Sidebar -->
  <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col">
    <div class="p-6 border-b border-gray-200">
      <h1 class="text-xl font-bold text-gray-800">Division Panel</h1>
    </div>
    <nav class="flex-1 p-4 space-y-2">
      <button (click)="switchView('form')" [class.bg-blue-50]="currentView === 'form'"
        [class.text-blue-600]="currentView === 'form'"
        class="w-full flex items-center space-x-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors">
        <span>üìù</span>
        <span class="font-medium">New Entry</span>
      </button>

      <button (click)="switchView('list')" [class.bg-blue-50]="currentView === 'list'"
        [class.text-blue-600]="currentView === 'list'"
        class="w-full flex items-center space-x-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors">
        <span>üìã</span>
        <span class="font-medium">Records</span>
      </button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto p-8">

    <!-- Mobile Header -->
    <div class="md:hidden mb-6 flex justify-between items-center">
      <h1 class="text-xl font-bold text-gray-800">Division Panel</h1>
      <div class="flex space-x-2">
        <button (click)="switchView('form')" class="p-2 bg-white rounded-lg border">üìù</button>
        <button (click)="switchView('list')" class="p-2 bg-white rounded-lg border">üìã</button>
      </div>
    </div>

    <!-- Form View -->
    <div *ngIf="currentView === 'form'" class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
          {{ editingEntryId ? 'Update Recovery Entry' : 'New Recovery Entry' }}
        </h2>

        <form (ngSubmit)="onSubmit()">
          <!-- Name -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
            <div class="relative">
              <input type="text" [(ngModel)]="formData.fullName" name="fullName" placeholder="Enter full name" required
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow" />
              <span class="absolute left-3 top-3.5 text-gray-400">üë§</span>
            </div>
          </div>

          <!-- Mobile -->
          <div class="mb-8">
            <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number</label>
            <div class="relative">
              <input type="tel" [(ngModel)]="formData.mobileNumber" name="mobileNumber"
                placeholder="Enter mobile number" required
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow" />
              <span class="absolute left-3 top-3.5 text-gray-400">üìû</span>
            </div>
          </div>

          <!-- NPA Date -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">NPA Date</label>
            <div class="relative">
              <input type="date" [(ngModel)]="formData.npaDate" name="npaDate" required
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow" />
              <span class="absolute left-3 top-3.5 text-gray-400">üìÖ</span>
            </div>
          </div>

          <!-- Section Type -->
          <!-- <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Section Type</label>
            <div class="flex space-x-4">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" [(ngModel)]="formData.sectionType" name="sectionType" value="13(2)" required
                  class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" />
                <span class="text-sm font-medium text-gray-700">Section 13(2)</span>
                <span class="text-xs text-gray-500">(27 days Recovery)</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" [(ngModel)]="formData.sectionType" name="sectionType" value="13(4)" required
                  class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" />
                <span class="text-sm font-medium text-gray-700">Section 13(4)</span>
                <span class="text-xs text-gray-500">(75 days Recovery)</span>
              </label>
            </div>
          </div> -->

          <!-- Actions -->
          <button type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition-colors shadow-sm flex justify-center items-center space-x-2">
            <span>{{ editingEntryId ? 'Update Entry' : 'Send to Recovery Division' }}</span>
            <span>‚Üí</span>
          </button>

          <button *ngIf="editingEntryId" type="button" (click)="resetForm(); currentView='list'"
            class="w-full mt-3 text-gray-500 hover:text-gray-700 py-2">
            Cancel
          </button>
        </form>
      </div>
    </div>

    <!-- List View -->
    <div *ngIf="currentView === 'list'" class="max-w-6xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
          <h2 class="text-lg font-bold text-gray-800">Submitted Files</h2>
          <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">
            Total: {{ entries.length }}
          </span>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="bg-gray-50 text-gray-600 text-sm uppercase tracking-wider">
                <th class="px-6 py-4 font-semibold border-b">File Details</th>
                <th class="px-6 py-4 font-semibold border-b">Status</th>
                <th class="px-6 py-4 font-semibold border-b w-1/3">Journey Log</th>
                <th class="px-6 py-4 font-semibold border-b text-right">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <tr *ngFor="let entry of entries; let i = index" class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4">
                  <div class="font-medium text-gray-800">{{ entry.fullName }}</div>
                  <div class="text-sm text-gray-500">{{ entry.mobileNumber }}</div>
                  <div class="mt-1">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                      [class.bg-purple-100]="entry.sectionType === '13(2)'"
                      [class.text-purple-800]="entry.sectionType === '13(2)'"
                      [class.bg-indigo-100]="entry.sectionType === '13(4)'"
                      [class.text-indigo-800]="entry.sectionType === '13(4)'">
                      {{ entry.sectionType }}
                    </span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                    [class.bg-green-100]="entry.status === 'Pending'"
                    [class.text-green-800]="entry.status === 'Pending'" [class.bg-red-100]="entry.status === 'Urgent'"
                    [class.text-red-800]="entry.status === 'Urgent'" [class.bg-yellow-100]="entry.status === 'Late'"
                    [class.text-yellow-800]="entry.status === 'Late'">
                    {{ entry.status }}
                  </span>
                  <!-- Deadline Display -->
                  <div class="mt-2 text-xs"
                    [ngClass]="{'text-red-600': isOverdue(entry), 'text-gray-500': !isOverdue(entry)}">
                    NPA Date: {{ entry.npaDate | date:'MMM d, y' }}
                    <span *ngIf="isOverdue(entry)" class="ml-1 font-medium">
                      (Overdue by {{ getDaysOverdue(entry) }} day{{ getDaysOverdue(entry) > 1 ? 's' : '' }})
                    </span>
                    <span *ngIf="!isOverdue(entry)" class="ml-1">
                      - Max allowed: {{ entry.deadlineDate | date:'MMM d, y' }}
                    </span>
                  </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  <!-- NPA Date Field Display -->
                  <div *ngIf="entry.npaDate" class="mb-3 p-2 bg-gray-100 rounded text-xs">
                    <span class="font-medium text-gray-700">NPA Date:</span> {{ entry.npaDate }}
                  </div>
                  <!-- History Stack -->
                  <div class="space-y-2">
                    <div *ngFor="let log of entry.history" class="flex items-start space-x-2 text-xs"
                      [class.bg-red-50]="log.isLate" [class.pr-2]="log.isLate" [class.rounded]="log.isLate">
                      <div class="mt-0.5 w-1.5 h-1.5 rounded-full"
                        [ngClass]="{'bg-blue-400': log.location==='Division', 'bg-purple-400': log.location==='Recovery', 'bg-red-500': log.isLate}">
                      </div>
                      <div>
                        <span class="font-semibold text-gray-700">{{ log.location }}</span>
                        <span class="text-gray-400 mx-1">‚Ä¢</span>
                        <span [class.text-red-600]="log.isLate" [class.font-medium]="log.isLate">{{ log.action }}</span>
                        <div class="text-gray-400 text-[10px]">{{ log.timestamp | date:'short' }}</div>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 text-right space-x-2 align-top">

                  <!-- Only show actions if file is still in Division -->
                  <ng-container *ngIf="entry.currentLocation === 'Division'; else readOnlyActions">

                    <!-- Final Stage: Returned from RO with Valuation -->
                    <ng-container *ngIf="isReturnedFromRO(entry); else normalActions">
                      <ng-container *ngIf="!isFullyCompleted(entry); else completedActions">
                        <button (click)="openCompletionModal(entry)" title="Complete Process"
                          class="px-3 py-1.5 text-sm font-medium text-green-600 bg-green-50 hover:bg-green-100 rounded transition flex items-center space-x-1">
                          <span>üèÅ</span>
                          <span>Complete</span>
                        </button>
                      </ng-container>
                      <ng-template #completedActions>
                        <span
                          class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-600 border border-green-200">
                          ‚úÖ Finalized
                        </span>
                      </ng-template>
                    </ng-container>

                    <!-- Normal Stage: New Entry -->
                    <ng-template #normalActions>
                      <button (click)="markUrgent(entry.id)" title="Urgent Send"
                        class="p-1.5 text-red-600 hover:bg-red-50 rounded transition">
                        üöÄ
                      </button>
                      <button (click)="editEntry(entry)" title="Edit"
                        class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition">
                        ‚úèÔ∏è
                      </button>
                      <button (click)="deleteEntry(entry.id)" title="Delete"
                        class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition">
                        üóëÔ∏è
                      </button>
                    </ng-template>

                  </ng-container>

                  <ng-template #readOnlyActions>
                    <span
                      class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-500 border border-gray-200">
                      üîí Transferred
                    </span>
                  </ng-template>

                </td>
              </tr>
              <tr *ngIf="entries.length === 0">
                <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                  <div class="flex flex-col items-center justify-center space-y-3">
                    <span class="text-4xl">üì≠</span>
                    <p>No active files in Division.</p>
                    <button (click)="switchView('form')" class="text-blue-600 hover:underline text-sm">Create new
                      entry</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal for Final completion (Minutes & Reserve Price) -->
<div *ngIf="selectedEntryForCompletion"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-gray-800">
        Final Process Completion
      </h3>
      <button (click)="closeCompletionModal()" class="text-gray-400 hover:text-gray-600">
        <span class="text-2xl">√ó</span>
      </button>
    </div>

    <div class="p-6">
      <div class="mb-4 bg-blue-50 p-4 rounded-lg">
        <h4 class="text-sm font-bold text-blue-800 mb-2">Valuation Details (From RO)</h4>
        <div class="text-sm text-blue-700">
          <p>Amount: ‚Çπ{{ selectedEntryForCompletion.valuationAmount?.toLocaleString('en-IN') }}</p>
          <p>File: {{ selectedEntryForCompletion.roValuationFileName }}</p>
        </div>
      </div>

      <!-- Reserve Price -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Reserve Price (‚Çπ) *</label>
        <input type="number" [(ngModel)]="reservePrice" placeholder="Enter Reserve Price" required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow" />
      </div>

      <!-- Minutes File Upload -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Minutes Document *</label>
        <div class="relative">
          <input type="file" (change)="onMinutesFileSelected($event)" accept=".pdf,.doc,.docx"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow" />
          <span class="absolute right-3 top-3.5 text-gray-400">üìé</span>
        </div>
        <div *ngIf="minutesFileName" class="mt-2 text-sm text-green-600">
          ‚úì Selected: {{ minutesFileName }}
        </div>
      </div>

      <!-- Actions -->
      <div class="flex space-x-3">
        <button (click)="submitCompletion()"
          class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-lg transition-colors flex justify-center items-center space-x-2">
          <span>üì§</span>
          <span>Send to Recovery Cell</span>
        </button>
        <button (click)="closeCompletionModal()"
          class="px-6 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 rounded-lg transition-colors">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>